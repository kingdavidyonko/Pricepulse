name: Frontend Unit Tests

on:
  push:
  pull_request:

jobs:
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Debug repo layout
        run: |
          echo "Workdir: $(pwd)"
          echo "Contents:"
          ls -la
          echo "Frontend folder listing:"
          ls -la frontend || true
          echo "Show frontend/package.json if present:"
          test -f frontend/package.json && cat frontend/package.json || echo "no frontend/package.json"
          echo "Show git status:"
          git status --porcelain

      - name: Install dependencies (resilient + verbose)
        run: |
          set -euxo pipefail
          cd frontend || { echo "frontend folder missing"; exit 0; }
          mkdir -p test-results
          echo "Node $(node -v)  npm $(npm -v)"
          echo "Attempting npm ci (preferred) with verbose logging..."
          npm ci --prefer-offline --no-audit --no-fund --loglevel verbose 2>&1 | tee npm-ci.log || {
            echo "npm ci failed â€” falling back to npm install (verbose)"
            npm install --no-audit --no-fund --loglevel verbose 2>&1 | tee npm-install.log
          }
          echo "Installed top-level packages:"
          npm ls --depth=0 || true
          tail -n 200 npm-ci.log || tail -n 200 npm-install.log || true

      - name: Run unit tests (capture JSON)
        run: |
          set -euxo pipefail
          cd frontend || { echo "frontend folder missing"; exit 0; }
          mkdir -p test-results
          if npm run | grep -q "test"; then
            echo "Running npm test (with JSON output where supported)..."
            npm test -- --json --outputFile=./test-results/jest-output.json --runInBand || true
          else
            echo "No npm test script found, trying npx jest..."
            npx jest --json --outputFile=./test-results/jest-output.json --runInBand || true
          fi
          if [ ! -f test-results/jest-output.json ]; then
            echo '{"numTotalTests":0,"message":"no-tests-run"}' > test-results/jest-output.json
          fi
          jq '. | {numTotalTests, numPassedTests, numFailedTests, success}' test-results/jest-output.json > test-results/jest-summary.json || echo '{"note":"summary-unavailable"}' > test-results/jest-summary.json
          echo "Test summary:"
          cat test-results/jest-summary.json

      - name: Upload test logs and artifacts
      - name: Install dependencies
        run: |
          cd frontend
          npm ci || npm install

      - name: Run unit tests
        run: |
          cd frontend
          npm test --silent
        env:
          CI: true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-logs
          path: |
            frontend/npm-ci.log
            frontend/npm-install.log
            frontend/test-results/**
            frontend/coverage/**

      - name: Post-run debug snippet (for quick glance)
        if: always()
        run: |
          echo "==== small install logs (tail) ===="
          test -f frontend/npm-ci.log && tail -n 200 frontend/npm-ci.log || true
          test -f frontend/npm-install.log && tail -n 200 frontend/npm-install.log || true
          echo "==== tests json summary ===="
          cat frontend/test-results/jest-summary.json || true
          path: frontend/test-results || frontend/jest-output.log || frontend/coverage || frontend/.output || frontend/**/jest*.log
